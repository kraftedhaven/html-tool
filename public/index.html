<!DOCTYPE html>
<html lang="en" id="htmlRoot">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neural Listing Engine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'JetBrains Mono', 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
            background: #000000;
            color: #e0e0e0;
            min-height: 100vh;
            line-height: 1.4;
            overflow-x: hidden;
        }
        
        .grid-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(64, 64, 64, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(64, 64, 64, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: -1;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 60px 20px;
            position: relative;
        }
        
        .header {
            text-align: center;
            margin-bottom: 80px;
            position: relative;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 2px;
            background: linear-gradient(90deg, transparent, #404040, transparent);
        }
        
        .header h1 {
            font-size: 2.8rem;
            font-weight: 300;
            color: #ffffff;
            margin-bottom: 16px;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }
        
        .header .subtitle {
            font-size: 0.9rem;
            color: #606060;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: 20px;
        }
        
        .header p {
            font-size: 1rem;
            color: #808080;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .upload-zone {
            background: linear-gradient(135deg, #0a0a0a, #111111);
            border: 1px solid #202020;
            border-radius: 2px;
            padding: 80px 40px;
            text-align: center;
            margin-bottom: 60px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .upload-zone::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(64, 64, 64, 0.1), transparent);
            transition: left 0.5s ease;
        }
        
        .upload-zone:hover::before {
            left: 100%;
        }
        
        .upload-zone:hover {
            border-color: #404040;
            background: linear-gradient(135deg, #111111, #1a1a1a);
        }
        
        .upload-zone.dragover {
            border-color: #606060;
            background: linear-gradient(135deg, #1a1a1a, #222222);
        }
        
        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 30px;
            opacity: 0.6;
            stroke-width: 1;
        }
        
        .upload-text {
            font-size: 1.1rem;
            color: #e0e0e0;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 300;
        }
        
        .upload-subtext {
            color: #606060;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        #fileInput {
            display: none;
        }
        
        .neural-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 60px;
        }
        
        .neural-item {
            background: linear-gradient(135deg, #0f0f0f, #1a1a1a);
            border: 1px solid #202020;
            border-radius: 2px;
            overflow: hidden;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .neural-item:hover {
            border-color: #404040;
            transform: translateY(-2px);
        }
        
        .neural-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #404040, transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .neural-item:hover::before {
            opacity: 1;
        }
        
        .neural-item img {
            width: 100%;
            height: 220px;
            object-fit: cover;
            filter: contrast(1.1) brightness(0.9);
        }
        
        .neural-info {
            padding: 20px;
        }
        
        .neural-filename {
            font-size: 0.8rem;
            color: #606060;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .neural-status {
            font-size: 0.75rem;
            padding: 6px 12px;
            border-radius: 1px;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 500;
        }
        
        .status-idle {
            background: #1a1a1a;
            color: #606060;
            border: 1px solid #303030;
        }
        
        .status-processing {
            background: #0f1419;
            color: #4a9eff;
            border: 1px solid #1e3a5f;
            animation: pulse 2s infinite;
        }
        
        .status-complete {
            background: #0f1a0f;
            color: #40ff40;
            border: 1px solid #1e3f1e;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .control-panel {
            display: flex;
            gap: 24px;
            justify-content: center;
            margin-bottom: 60px;
            flex-wrap: wrap;
        }
        
        .neural-btn {
            padding: 16px 32px;
            border-radius: 1px;
            border: 1px solid #303030;
            font-size: 0.9rem;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 160px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }
        
        .neural-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(64, 64, 64, 0.1), transparent);
            transition: left 0.3s ease;
        }
        
        .neural-btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            color: #e0e0e0;
            border-color: #404040;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #2a2a2a, #3a3a3a);
            border-color: #606060;
        }
        
        .btn-primary:disabled {
            background: linear-gradient(135deg, #0f0f0f, #1a1a1a);
            color: #404040;
            border-color: #202020;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: transparent;
            color: #808080;
            border-color: #303030;
        }
        
        .btn-secondary:hover {
            border-color: #404040;
            background: linear-gradient(135deg, #0f0f0f, #1a1a1a);
            color: #a0a0a0;
        }
        
        .output-terminal {
            background: linear-gradient(135deg, #0a0a0a, #111111);
            border: 1px solid #202020;
            border-radius: 2px;
            padding: 40px;
            margin-top: 60px;
            position: relative;
        }
        
        .output-terminal::before {
            content: 'NEURAL OUTPUT';
            position: absolute;
            top: -1px;
            left: 20px;
            background: #000000;
            padding: 0 12px;
            font-size: 0.7rem;
            color: #606060;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .terminal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #202020;
        }
        
        .terminal-title {
            font-size: 1.1rem;
            font-weight: 300;
            color: #e0e0e0;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .data-display {
            background: #000000;
            border: 1px solid #1a1a1a;
            border-radius: 1px;
            padding: 30px;
            overflow-x: auto;
            font-family: inherit;
            font-size: 0.8rem;
            line-height: 1.5;
            color: #a0a0a0;
            position: relative;
        }
        
        .data-display::before {
            content: 'CSV';
            position: absolute;
            top: -1px;
            right: 12px;
            background: #000000;
            padding: 0 8px;
            font-size: 0.6rem;
            color: #404040;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .processing-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 60px;
            color: #606060;
        }
        
        .neural-spinner {
            width: 24px;
            height: 24px;
            border: 1px solid #202020;
            border-top: 1px solid #606060;
            border-radius: 50%;
            animation: neuralSpin 1.5s linear infinite;
        }
        
        @keyframes neuralSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }
        
        .metric-node {
            background: linear-gradient(135deg, #000000, #0f0f0f);
            padding: 30px;
            border-radius: 1px;
            text-align: center;
            border: 1px solid #1a1a1a;
            position: relative;
        }
        
        .metric-node::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #303030, transparent);
        }
        
        .metric-value {
            font-size: 2.4rem;
            font-weight: 200;
            color: #ffffff;
            margin-bottom: 8px;
            letter-spacing: 0.05em;
        }
        
        .metric-label {
            color: #606060;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .control-panel input[type="text"], .insights-panel input[type="text"] {
            background: #0a0a0a;
            border: 1px solid #303030;
            color: #e0e0e0;
            padding: 12px 16px;
            border-radius: 1px;
            font-family: inherit;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }
        .control-panel input[type="text"]:focus, .insights-panel input[type="text"]:focus {
            outline: none;
            border-color: #4a9eff;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 40px 15px;
            }
            
            .header h1 {
                font-size: 2.2rem;
            }
            
            .upload-zone {
                padding: 60px 20px;
            }
            
            .control-panel {
                flex-direction: column;
                align-items: center;
            }
            
            .neural-btn {
                width: 100%;
                max-width: 320px;
            }
            
            .neural-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #404040, transparent);
            animation: scanLine 3s linear infinite;
            opacity: 0.6;
        }
        
        @keyframes scanLine {
            0% { transform: translateY(0); opacity: 0; }
            50% { opacity: 0.6; }
            100% { transform: translateY(400px); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="grid-bg"></div>
    
    <div class="container">
        <div class="header">
            <h1>Neural Listing Engine</h1>
            <div class="subtitle">Autonomous Product Analysis System</div>
            <p>Advanced neural networks process product imagery to generate comprehensive marketplace data with quantum precision</p>
        </div>
        
        <div class="upload-zone" id="uploadZone">
            <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="17 8 12 3 7 8" />
                <line x1="12" y1="3" x2="12" y2="15" />
            </svg>
            <div class="upload-text">Initialize Data Upload</div>
            <div class="upload-subtext">Drop image files or click to browse • JPG/PNG • 5-10 units recommended</div>
            <input type="file" id="fileInput" multiple accept="image/*">
            <input type="file" id="cameraInputRear" accept="image/*" capture="environment" style="display:none">
            <input type="file" id="cameraInputFront" accept="image/*" capture="user" style="display:none">
        </div>

        <div class="control-panel">
             <button class="neural-btn btn-secondary" id="cameraBtn">Use Camera</button>
        </div>

        <div class="neural-grid" id="neuralGrid"></div>
        
        <div class="control-panel" id="mainControls">
            <button class="neural-btn btn-secondary" id="clearBtn">Reset System</button>
            <button class="neural-btn btn-primary" id="analyzeBtn" disabled>Execute Analysis</button>
            <button class="neural-btn btn-primary" id="uploadEbayBtn" disabled>Upload to eBay</button>
            <button class="neural-btn btn-secondary" id="downloadBtn" disabled>Export CSV</button>
        </div>
        
        <div class="output-terminal hidden insights-panel" id="niftyPanel">
            <div class="terminal-header" style="margin-bottom: 20px;">
                <h2 class="terminal-title">Nifty Enrichment</h2>
            </div>
            <div class="control-panel" style="margin-bottom: 0;">
                <button class="neural-btn btn-secondary" id="niftyIngestBtn">Load Nifty CSV/JSON</button>
                <button class="neural-btn btn-primary" id="niftyEnrichBtn" disabled>Enrich From Nifty</button>
                <input id="niftyFile" type="file" accept=".csv,.json" style="display:none" />
            </div>
        </div>

        <div class="output-terminal hidden insights-panel" id="strPanel">
            <div class="terminal-header" style="margin-bottom: 20px;">
                <h2 class="terminal-title">Sold-Through Insights</h2>
            </div>
            <div class="control-panel" style="margin-bottom: 0; gap: 12px;">
                <input id="strQuery" type="text" placeholder="Enter search keyword (e.g., 'Carhartt tee')" style="flex:1;min-width:220px">
                <input id="strCat" type="text" placeholder="Category ID (optional)" style="width:180px">
                <button class="neural-btn btn-primary" id="strCalcBtn">Calculate STR</button>
            </div>
        </div>
        
        <div class="output-terminal hidden" id="outputTerminal">
            <div class="scan-line"></div>
            
            <div class="terminal-header">
                <h2 class="terminal-title">Analysis Complete</h2>
            </div>
            
            <div class="metrics-grid" id="metricsGrid">
                <div class="metric-node">
                    <div class="metric-value" id="totalUnits">00</div>
                    <div class="metric-label">Units Processed</div>
                </div>
                <div class="metric-node">
                    <div class="metric-value" id="accuracyRate">00%</div>
                    <div class="metric-label">Accuracy Rate</div>
                </div>
                <div class="metric-node">
                    <div class="metric-value" id="avgConfidence">00%</div>
                    <div class="metric-label">Neural Confidence</div>
                </div>
            </div>
            
            <div class="data-display" id="dataDisplay">
                <div class="processing-indicator">
                    <div class="neural-spinner"></div>
                    <span>Executing neural analysis protocols...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        class NeuralListingEngine {
            constructor() {
                this.uploadedFiles = [];
                this.processedData = [];
                this.niftyData = null;
                this.isProcessing = false;
                this.initializeDOM();
                this.bindEvents();
            }

            initializeDOM() {
                this.uploadZone = document.getElementById('uploadZone');
                this.fileInput = document.getElementById('fileInput');
                this.neuralGrid = document.getElementById('neuralGrid');
                this.analyzeBtn = document.getElementById('analyzeBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.downloadBtn = document.getElementById('downloadBtn');
                this.uploadEbayBtn = document.getElementById('uploadEbayBtn');
                this.outputTerminal = document.getElementById('outputTerminal');
                this.dataDisplay = document.getElementById('dataDisplay');
                this.cameraBtn = document.getElementById('cameraBtn');
                this.cameraInputRear = document.getElementById('cameraInputRear');

                // Nifty
                this.niftyPanel = document.getElementById('niftyPanel');
                this.niftyIngestBtn = document.getElementById('niftyIngestBtn');
                this.niftyFile = document.getElementById('niftyFile');
                this.niftyEnrichBtn = document.getElementById('niftyEnrichBtn');

                // STR
                this.strPanel = document.getElementById('strPanel');
                this.strCalcBtn = document.getElementById('strCalcBtn');
                this.strQuery = document.getElementById('strQuery');
                this.strCat = document.getElementById('strCat');
            }

            bindEvents() {
                this.uploadZone.addEventListener('click', () => this.fileInput.click());
                this.uploadZone.addEventListener('dragover', (e) => this.handleDragOver(e));
                this.uploadZone.addEventListener('drop', (e) => this.handleDrop(e));
                this.uploadZone.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                this.cameraBtn.addEventListener('click', () => this.cameraInputRear.click());
                this.cameraInputRear.addEventListener('change', (e) => this.handleFileSelect(e));

                this.analyzeBtn.addEventListener('click', () => this.executeAnalysis());
                this.clearBtn.addEventListener('click', () => this.resetSystem());
                this.downloadBtn.addEventListener('click', () => this.exportCsv());
                this.uploadEbayBtn.addEventListener('click', () => this.uploadToEbay());

                // Nifty Events (assuming they are implemented elsewhere or will be)
                this.niftyIngestBtn.addEventListener('click', () => this.niftyFile.click());
                this.niftyFile.addEventListener('change', (e) => this.handleNiftyFile(e));
                this.niftyEnrichBtn.addEventListener('click', () => this.enrichFromNifty());

                // STR Events
                this.strCalcBtn.addEventListener('click', () => this.calculateStr());
                this.strQuery.addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') this.calculateStr();
                });
            }

            handleDragOver(e) {
                e.preventDefault();
                this.uploadZone.classList.add('dragover');
            }
            
            handleDragLeave(e) {
                e.preventDefault();
                this.uploadZone.classList.remove('dragover');
            }
            
            async handleDrop(e) {
                e.preventDefault();
                this.uploadZone.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
                await this.processFiles(files);
            }
            
            async handleFileSelect(e) {
                const files = Array.from(e.target.files);
                await this.processFiles(files);
            }

            async _compressImage(file, maxSide = 1600, quality = 0.8) {
                const bitmap = await createImageBitmap(file);
                const ratio = Math.min(1, maxSide / Math.max(bitmap.width, bitmap.height));
                const w = Math.round(bitmap.width * ratio);
                const h = Math.round(bitmap.height * ratio);

                const canvas = document.createElement('canvas');
                canvas.width = w;
                canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(bitmap, 0, 0, w, h);

                const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', quality));
                return new File([blob], file.name.replace(/\.(png|heic|heif|webp)$/i, '.jpg'), { type: 'image/jpeg' });
            }
            
            async processFiles(files) {
                this.uploadZone.style.cursor = 'wait';
                document.body.style.cursor = 'wait';
                for (const file of files) {
                    if (file.type.startsWith('image/')) {
                        try {
                            const resizedFile = await this._compressImage(file);
                            this.uploadedFiles.push(resizedFile);
                            this.createNeuralNode(resizedFile);
                        } catch (error) {
                            console.error(`Failed to resize ${file.name}:`, error);
                            this.showError(`Could not process image: ${file.name}. It may be corrupted.`);
                        }
                    }
                }
                this.uploadZone.style.cursor = 'pointer';
                document.body.style.cursor = 'default';
                this.updateControlPanel();
            }

            createNeuralNode(file) {
                const node = document.createElement('div');
                node.className = 'neural-item';
                
                const img = document.createElement('img');
                const objectUrl = URL.createObjectURL(file);
                img.src = objectUrl;
                img.onload = () => URL.revokeObjectURL(objectUrl); // Revoke after load to free memory
                
                const info = document.createElement('div');
                info.className = 'neural-info';
                
                info.innerHTML = `
                    <div class="neural-filename">${file.name}</div>
                    <span class="neural-status status-idle">Standby</span>
                `;
                
                node.appendChild(img);
                node.appendChild(info);
                this.neuralGrid.appendChild(node);
            }

            updateControlPanel() {
                const hasFiles = this.uploadedFiles.length > 0;
                const hasData = this.processedData.length > 0;
                this.analyzeBtn.disabled = !hasFiles || this.isProcessing;
                this.clearBtn.disabled = !hasFiles && !hasData;
                this.uploadEbayBtn.disabled = !hasData || this.isProcessing;
                this.downloadBtn.disabled = !hasData;
                this.niftyEnrichBtn.disabled = !hasData || !this.niftyData;

                if (hasFiles) {
                    this.niftyPanel.classList.remove('hidden');
                    this.strPanel.classList.remove('hidden');
                } else {
                    this.niftyPanel.classList.add('hidden');
                    this.strPanel.classList.add('hidden');
                }
            }

            resetSystem() {
                this.uploadedFiles = [];
                this.processedData = [];
                this.neuralGrid.innerHTML = '';
                this.outputTerminal.classList.add('hidden');
                this.fileInput.value = '';
                this.cameraInputRear.value = '';
                this.updateControlPanel();
            }

            async _callApi(endpoint, options = {}) {
                const { body, isForm } = options;
                const headers = {};
                headers['x-hht-key'] = 'YOUR_VERIFY_TOKEN'; // <-- IMPORTANT: Replace with your actual token
                if (!isForm && body) {
                    headers['Content-Type'] = 'application/json';
                }

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 58000); // 58-second timeout, just under the server's 60s

                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers,
                        body,
                        signal: controller.signal
                    });

                    const text = await response.text();
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch {
                        throw new Error(text.slice(0, 200));
                    }

                    if (!response.ok) {
                        throw new Error(data.error || 'Request failed');
                    }
                    return data;
                } catch (error) {
                    if (error.name === 'AbortError') {
                        throw new Error('Request timed out. The server may be busy or the analysis is taking too long. Check the Vercel logs for more details.');
                    }
                    throw error; // Re-throw other errors
                } finally {
                    clearTimeout(timeoutId);
                }
            }

            _mapItemToSchema(item, i) {
                return {
                    filename: this.uploadedFiles[i]?.name || 'N/A',
                    title: item.seoTitle || item.title || '',
                    description: item.keyFeatures ? String(item.keyFeatures) : '',
                    size: item.size || '',
                    color: typeof item.color === 'object' && item.color ? [item.color.primary, item.color.secondary].filter(Boolean).join(', ') : item.color || '',
                    brand: item.brand || '',
                    condition: item.condition || '',
                    price: item.suggestedPrice || '',
                    category: item.categoryName || '',
                    categoryId: item.categoryId || '',
                    countryOfManufacture: item.countryOfManufacture || '',
                    material: item.material || '',
                    fabricType: item.fabricType || '',
                    theme: item.theme || '',
                    yearManufactured: item.estimatedYear || '',
                    isVintage: item.estimatedYear ? (Number(item.estimatedYear) < 2005 ? 'Yes' : 'No') : '',
                    confidence: item.confidence || 0
                };
            }

            async executeAnalysis() {
                if (this.isProcessing || this.uploadedFiles.length === 0) return;
                this.isProcessing = true;
                this.analyzeBtn.textContent = 'Processing...';
                this.updateControlPanel();
                this.outputTerminal.classList.remove('hidden');
                this.dataDisplay.innerHTML = `
                    <div class="processing-indicator">
                        <div class="neural-spinner"></div>
                        <span>Executing neural analysis protocols...</span>
                    </div>`;

                const statusElements = Array.from(document.querySelectorAll('.neural-status'));
                this.processedData = []; // Reset results

                try {
                    for (let i = 0; i < this.uploadedFiles.length; i++) {
                        const file = this.uploadedFiles[i];
                        if (statusElements[i]) {
                            statusElements[i].className = 'neural-status status-processing';
                            statusElements[i].textContent = `Analyzing ${i + 1}/${this.uploadedFiles.length}`;
                        }

                        const formData = new FormData();
                        formData.append('images', file);

                        const result = await this._callApi('/api/neuralSuggest', { body: formData, isForm: true });
                        const item = (result.data && result.data[0]) || {};
                        
                        const processedItem = this._mapItemToSchema(item, i);
                        this.processedData.push(processedItem);

                        this.updateMetrics();
                        this.generateDataOutput();

                        if (statusElements[i]) {
                            statusElements[i].className = 'neural-status status-complete';
                            statusElements[i].textContent = 'Complete';
                        }
                    }

                } catch (error) {
                    this.showError('Analysis failed: ' + error.message);
                } finally {
                    this.isProcessing = false;
                    this.analyzeBtn.textContent = 'Execute Analysis';
                    this.updateControlPanel();
                }
            }

            async calculateStr() {
                const query = this.strQuery.value;
                const categoryId = this.strCat.value;
                if (!query) {
                    this.showError('Please enter a keyword to calculate Sold-Through Rate.');
                    return;
                }

                this.dataDisplay.innerHTML = `
                    <div class="processing-indicator">
                        <div class="neural-spinner"></div>
                        <span>Querying eBay for live market data...</span>
                    </div>`;
                this.outputTerminal.classList.remove('hidden');

                try {
                    const result = await this._callApi('/api/ebayComps', { body: JSON.stringify({ query, categoryId }) });
                    this.dataDisplay.innerHTML = `
                        <div style="text-align:center; padding: 20px; color: #e0e0e0;">
                            <h3 style="color:#fff; margin-bottom: 20px;">Live STR for "${query}"</h3>
                            <p>Active Listings: ${result.activeCount}</p><p>Sold Listings: ${result.soldCount}</p>
                            <p style="font-size: 1.5rem; color: #40ff40; margin-top: 10px;">STR: ${result.str}%</p>
                        </div>`;
                } catch (error) {
                    this.showError(`STR Calculation Failed: ${error.message}`);
                }
            }

            updateMetrics() {
                const totalUnits = this.processedData.length;
                document.getElementById('totalUnits').textContent = String(totalUnits).padStart(2, '0');

                if (totalUnits > 0) {
                    const totalConfidence = this.processedData.reduce((sum, item) => sum + (item.confidence || 0), 0);
                    const avgConfidence = Math.round((totalConfidence / totalUnits) * 100);
                    document.getElementById('avgConfidence').textContent = `${avgConfidence}%`;
                } else {
                    document.getElementById('avgConfidence').textContent = '0%';
                }
                // Accuracy is subjective and not provided by the API, so it remains a placeholder.
                document.getElementById('accuracyRate').textContent = '--%';
            }

            _generateCsvContent() {
                if (this.processedData.length === 0) return '';

                const headers = Object.keys(this.processedData[0]);
                let csvContent = headers.join(',') + '\n';

                this.processedData.forEach(item => {
                    const row = headers.map(header => {
                        const value = item[header] === null || item[header] === undefined ? '' : String(item[header]);
                        return `"${value.replace(/"/g, '""')}"`;
                    });
                    csvContent += row.join(',') + '\n';
                });
                return csvContent;
            }

            generateDataOutput() {
                const csvContent = this._generateCsvContent();
                this.dataDisplay.innerHTML = `<pre>${csvContent}</pre>`;
            }

            exportCsv() {
                const csvContent = this._generateCsvContent();
                if (!csvContent) return;

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `neural_listings_${new Date().toISOString().slice(0, 10)}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            showError(message) {
                this.dataDisplay.innerHTML = `<pre style="color: #ff4040;">${message}</pre>`;
                const statusElements = document.querySelectorAll('.neural-status');
                statusElements.forEach(el => {
                    el.className = 'neural-status status-idle';
                    el.textContent = 'Error';
                });
            }

            async uploadToEbay() {
                if (this.isProcessing || !this.processedData.length) return;
                this.isProcessing = true;
                this.uploadEbayBtn.textContent = 'Uploading...';
                this.updateControlPanel();
                this.dataDisplay.innerHTML = `<div class="processing-indicator"><div class="neural-spinner"></div><span>1/3: Uploading images to eBay...</span></div>`;

                try {
                    // Step 1: Upload images to eBay EPS
                    const imageFormData = new FormData();
                    this.uploadedFiles.forEach(file => {
                        imageFormData.append('images', file);
                    });
                    const imageUploadResult = await this._callApi('/api/uploadEbayImage', { body: imageFormData, isForm: true });

                    // Step 2: Prepare listings with EPS URLs
                    this.dataDisplay.innerHTML = `<div class="processing-indicator"><div class="neural-spinner"></div><span>2/3: Creating listings...</span></div>`;
                    const listingsPayload = this.processedData.map((item, index) => {
                        // A simple way to generate a unique SKU
                        const sku = item.sku || `NLE-${Date.now()}-${index}`;
                        return {
                            ...item,
                            sku: sku,
                            price: item.price || '0.00', // Ensure price is set
                            imageUrls: imageUploadResult.uploaded.map(img => img.epsImageUrl)
                        };
                    });

                    // Step 3: Bulk upload to eBay
                    this.dataDisplay.innerHTML = `<div class="processing-indicator"><div class="neural-spinner"></div><span>3/3: Publishing to eBay...</span></div>`;
                    const bulkUploadResult = await this._callApi('/api/createListing', { body: JSON.stringify({ listings: listingsPayload }) });

                    this.dataDisplay.innerHTML = `<pre>eBay Upload Complete!\n\n${JSON.stringify(bulkUploadResult, null, 2)}</pre>`;
                } catch (error) {
                    this.dataDisplay.innerHTML = `<pre style="color: #ff4040;">eBay Upload Error: ${error.message}</pre>`;
                } finally {
                    this.isProcessing = false;
                    this.uploadEbayBtn.textContent = 'Upload to eBay';
                    this.updateControlPanel();
                }
            }

            _parseCsv(text) {
                const lines = text.trim().replace(/\r/g, '').split('\n');
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                return lines.slice(1).map(line => {
                    // This is a simple parser. It won't handle commas within quoted fields.
                    const values = line.split(',');
                    return headers.reduce((obj, header, index) => {
                        const value = values[index] ? values[index].trim().replace(/"/g, '') : '';
                        obj[header] = value;
                        return obj;
                    }, {});
                });
            }

            async handleNiftyFile(e) {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    if (file.name.endsWith('.json')) {
                        this.niftyData = JSON.parse(text);
                    } else {
                        this.niftyData = this._parseCsv(text);
                    }
                    this.niftyIngestBtn.textContent = `Loaded: ${file.name}`;
                    this.updateControlPanel();
                    this.dataDisplay.innerHTML = `<pre>${this.niftyData.length} Nifty records loaded.</pre>`;
                    this.outputTerminal.classList.remove('hidden');
                } catch (err) {
                    this.showError(`Failed to load Nifty file: ${err.message}`);
                }
            }

            enrichFromNifty() {
                if (!this.niftyData || !this.processedData.length) return;

                let enrichedCount = 0;
                this.processedData = this.processedData.map(item => {
                    // Simple matching by title. A more robust solution would use SKUs or fuzzy matching.
                    const niftyMatch = this.niftyData.find(niftyItem =>
                        niftyItem.Title && item.title.toLowerCase().includes(niftyItem.Title.toLowerCase())
                    );

                    if (niftyMatch) {
                        enrichedCount++;
                        // Enrich price and sku, but keep the AI-generated title
                        return { ...item, price: niftyMatch.Price || item.price, sku: niftyMatch.SKU || item.sku };
                    }
                    return item;
                });

                this.generateDataOutput();
                this.dataDisplay.innerHTML = `<pre>Enriched ${enrichedCount} items from Nifty data.\n\n${this._generateCsvContent()}</pre>`;
            }
        }
        
        // Initialize the Neural Listing Engine
        document.addEventListener('DOMContentLoaded', () => {
            new NeuralListingEngine();
        });
    </script>
</body>
</html>
                        this.uploadedFiles.push(file);
                        this.createNeuralNode(file);
                    }
                });
                this.updateControlPanel();
            }

            createNeuralNode(file) {
                const node = document.createElement('div');
                node.className = 'neural-item';
                
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                
                const info = document.createElement('div');
                info.className = 'neural-info';
                
                info.innerHTML = `
                    <div class="neural-filename">${file.name}</div>
                    <span class="neural-status status-idle">Standby</span>
                `;
                
                node.appendChild(img);
                node.appendChild(info);
                this.neuralGrid.appendChild(node);
            }

            updateControlPanel() {
                const hasFiles = this.uploadedFiles.length > 0;
                const hasData = this.processedData.length > 0;
                this.analyzeBtn.disabled = !hasFiles || this.isProcessing;
                this.clearBtn.disabled = !hasFiles && !hasData;
                this.uploadEbayBtn.disabled = !hasData || this.isProcessing;
                this.downloadBtn.disabled = !hasData;
                this.niftyEnrichBtn.disabled = !hasData;

                if (hasFiles) {
                    this.niftyPanel.classList.remove('hidden');
                    this.strPanel.classList.remove('hidden');
                } else {
                    this.niftyPanel.classList.add('hidden');
                    this.strPanel.classList.add('hidden');
                }
            }

            resetSystem() {
                this.uploadedFiles = [];
                this.processedData = [];
                this.neuralGrid.innerHTML = '';
                this.outputTerminal.classList.add('hidden');
                this.fileInput.value = '';
                this.updateControlPanel();
            }

            async _callApi(endpoint, options = {}) {
                const { body, isForm } = options;
                const headers = {};
                if (!isForm && body) {
                    headers['Content-Type'] = 'application/json';
                }

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 58000); // 58-second timeout, just under the server's 60s

                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers,
                        body,
                        signal: controller.signal
                    });

                    if (!response.ok) {
                        let error;
                        try {
                            // Try to parse the error as JSON, which is the expected format
                            const errorData = await response.json();
                            error = new Error(errorData.error || `API Error: ${response.statusText}`);
                        } catch (e) {
                            // If the error response isn't JSON, use the raw text
                            error = new Error(await response.text());
                        }
                        throw error;
                    }
                    return response.json();
                } catch (error) {
                    if (error.name === 'AbortError') {
                        throw new Error('Request timed out. The server may be busy or the analysis is taking too long. Check the Vercel logs for more details.');
                    }
                    throw error; // Re-throw other errors
                } finally {
                    clearTimeout(timeoutId);
                }
            }

            async executeAnalysis() {
                if (this.isProcessing || this.uploadedFiles.length === 0) return;
                this.isProcessing = true;
                this.analyzeBtn.textContent = 'Processing...';
                this.updateControlPanel();
                this.outputTerminal.classList.remove('hidden');
                this.dataDisplay.innerHTML = `
                    <div class="processing-indicator">
                        <div class="neural-spinner"></div>
                        <span>Executing neural analysis protocols...</span>
                    </div>`;

                const statusElements = document.querySelectorAll('.neural-status');
                statusElements.forEach(el => {
                    el.className = 'neural-status status-processing';
                    el.textContent = 'Processing';
                });

                try {
                     // 1) send images to the server
                    const formData = new FormData();
                    this.uploadedFiles.forEach(file => formData.append('images', file));
                    const { data } = await this._callApi('/api/analyze-images', { body: formData, isForm: true });
                    
                    // 2) store results and update UI
                    this.processedData = (data || []).map((item, i) => ({
                        filename: this.uploadedFiles[i]?.name || 'N/A',
                        title: item.seoTitle || item.title || '',
                        description: item.keyFeatures ? String(item.keyFeatures) : '',
                        size: item.size || '',
                        color: typeof item.color === 'object' && item.color ? [item.color.primary, item.color.secondary].filter(Boolean).join(', ') : item.color || '',
                        brand: item.brand || '',
                        condition: item.condition || '',
                        price: item.suggestedPrice || '',
                        category: item.categoryName || '',
                        categoryId: item.categoryId || '',
                        countryOfManufacture: item.countryOfManufacture || '',
                        material: item.material || '',
                        fabricType: item.fabricType || '',
                        theme: item.theme || '',
                        yearManufactured: item.estimatedYear || '',
                        isVintage: item.estimatedYear ? (Number(item.estimatedYear) < 2005 ? 'Yes' : 'No') : '',
                        confidence: item.confidence || 0
                    }));
                    
                    // set tile statuses to complete
                    statusElements.forEach((el, i) => {
                        if (i < this.processedData.length) {
                            el.className = 'neural-status status-complete';
                            el.textContent = 'Complete';
                        }
                    });
                    
                    // 3) update metrics + CSV preview
                    this.updateMetrics();
                    this.generateDataOutput();

                } catch (error) {
                    this.showError('Analysis failed: ' + error.message);
                } finally {
                    this.isProcessing = false;
                    this.analyzeBtn.textContent = 'Execute Analysis';
                    this.updateControlPanel();
                }
            }

            async calculateStr() {
                const query = this.strQuery.value;
                const categoryId = this.strCat.value;
                if (!query) {
                    this.showError('Please enter a keyword to calculate Sold-Through Rate.');
                    return;
                }

                this.dataDisplay.innerHTML = `
                    <div class="processing-indicator">
                        <div class="neural-spinner"></div>
                        <span>Querying eBay for live market data...</span>
                    </div>`;
                this.outputTerminal.classList.remove('hidden');

                try {
                    const result = await this._callApi('/api/ebay/str', { body: JSON.stringify({ query, categoryId }) });
                    this.dataDisplay.innerHTML = `
                        <div style="text-align:center; padding: 20px; color: #e0e0e0;">
                            <h3 style="color:#fff; margin-bottom: 20px;">Live STR for "${query}"</h3>
                            <p>Active Listings: ${result.activeCount}</p><p>Sold Listings: ${result.soldCount}</p>
                            <p style="font-size: 1.5rem; color: #40ff40; margin-top: 10px;">STR: ${result.str}%</p>
                        </div>`;
                } catch (error) {
                    this.showError(`STR Calculation Failed: ${error.message}`);
                }
            }

            updateMetrics() {
                const totalUnits = this.processedData.length;
                document.getElementById('totalUnits').textContent = String(totalUnits).padStart(2, '0');

                if (totalUnits > 0) {
                    const totalConfidence = this.processedData.reduce((sum, item) => sum + (item.confidence || 0), 0);
                    const avgConfidence = Math.round((totalConfidence / totalUnits) * 100);
                    document.getElementById('avgConfidence').textContent = `${avgConfidence}%`;
                } else {
                    document.getElementById('avgConfidence').textContent = '0%';
                }
                // Accuracy is subjective and not provided by the API, so it remains a placeholder.
                document.getElementById('accuracyRate').textContent = '--%';
            }

            _generateCsvContent() {
                if (this.processedData.length === 0) return '';

                const headers = Object.keys(this.processedData[0]);
                let csvContent = headers.join(',') + '\n';

                this.processedData.forEach(item => {
                    const row = headers.map(header => {
                        const value = item[header] === null || item[header] === undefined ? '' : String(item[header]);
                        return `"${value.replace(/"/g, '""')}"`;
                    });
                    csvContent += row.join(',') + '\n';
                });
                return csvContent;
            }

            generateDataOutput() {
                const csvContent = this._generateCsvContent();
                this.dataDisplay.innerHTML = `<pre>${csvContent}</pre>`;
            }

            exportCsv() {
                const csvContent = this._generateCsvContent();
                if (!csvContent) return;

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `neural_listings_${new Date().toISOString().slice(0, 10)}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            showError(message) {
                this.dataDisplay.innerHTML = `<pre style="color: #ff4040;">${message}</pre>`;
                const statusElements = document.querySelectorAll('.neural-status');
                statusElements.forEach(el => {
                    el.className = 'neural-status status-idle';
                    el.textContent = 'Error';
                });
            }

            async uploadToEbay() {
                if (this.isProcessing || !this.processedData.length) return;
                this.isProcessing = true;
                this.uploadEbayBtn.textContent = 'Uploading...';
                this.updateControlPanel();
                this.dataDisplay.innerHTML = `<div class="processing-indicator"><div class="neural-spinner"></div><span>1/3: Uploading images to eBay...</span></div>`;

                try {
                    // Step 1: Upload images to eBay EPS
                    const imageFormData = new FormData();
                    this.uploadedFiles.forEach(file => {
                        imageFormData.append('images', file);
                    });
                    const imageUploadResult = await this._callApi('/api/ebay/upload-images', { body: imageFormData, isForm: true });

                    // Step 2: Prepare listings with EPS URLs
                    this.dataDisplay.innerHTML = `<div class="processing-indicator"><div class="neural-spinner"></div><span>2/3: Creating listings...</span></div>`;
                    const listingsPayload = this.processedData.map((item, index) => {
                        // A simple way to generate a unique SKU
                        const sku = item.sku || `NLE-${Date.now()}-${index}`;
                        return {
                            ...item,
                            sku: sku,
                            price: item.price || '0.00', // Ensure price is set
                            imageUrls: imageUploadResult.uploaded.map(img => img.epsImageUrl)
                        };
                    });

                    // Step 3: Bulk upload to eBay
                    this.dataDisplay.innerHTML = `<div class="processing-indicator"><div class="neural-spinner"></div><span>3/3: Publishing to eBay...</span></div>`;
                    const bulkUploadResult = await this._callApi('/api/bulk-upload-ebay', { body: JSON.stringify({ listings: listingsPayload }) });

                    this.dataDisplay.innerHTML = `<pre>eBay Upload Complete!\n\n${JSON.stringify(bulkUploadResult, null, 2)}</pre>`;
                } catch (error) {
                    this.dataDisplay.innerHTML = `<pre style="color: #ff4040;">eBay Upload Error: ${error.message}</pre>`;
                } finally {
                    this.isProcessing = false;
                    this.uploadEbayBtn.textContent = 'Upload to eBay';
                    this.updateControlPanel();
                }
            }
        }
        
        // Initialize the Neural Listing Engine
        document.addEventListener('DOMContentLoaded', () => {
            new NeuralListingEngine();
        });
    </script>
</body>
</html>